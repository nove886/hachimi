name: ğŸ“ Hachimi Auto Checkin

on:
  workflow_dispatch:
  schedule:
    # UTC 00:12 = åŒ—äº¬æ—¶é—´ 08:12
    - cron: "12 0 * * *"

permissions:
  contents: write

concurrency:
  group: hachimi-auto-checkin
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1ï¸âƒ£ æ£€å‡ºå½“å‰ä»“åº“
      - name: ğŸ“¥ Checkout ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ è®¾ç½® Python
      - name: ğŸ è®¾ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      # 3ï¸âƒ£ å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆXvfb + ä¸­æ–‡å­—ä½“ï¼‰
      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb fonts-noto-cjk fonts-noto-cjk-extra

      # 4ï¸âƒ£ å®‰è£… Python ä¾èµ–
      - name: ğŸ“š å®‰è£… Python ä¾èµ–
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸ æœªæ‰¾åˆ° requirements.txt"
          fi

      # 5ï¸âƒ£ å®‰è£… Playwright æµè§ˆå™¨
      - name: ğŸŒ å®‰è£… Playwright
        run: |
          python -m playwright install --with-deps chromium

      # 6ï¸âƒ£ éšæœºå»¶è¿Ÿï¼ˆé˜²é£æ§ï¼‰
      - name: â³ éšæœºå»¶è¿Ÿ
        run: |
          delay=$((RANDOM % 120))
          echo "å»¶è¿Ÿ ${delay} ç§’"
          sleep $delay

      # 7ï¸âƒ£ æ‰§è¡Œç­¾åˆ°è„šæœ¬
      - name: ğŸš€ æ‰§è¡Œ Hachimi ç­¾åˆ°
        env:
          HACHIMI_BATCH: ${{ secrets.HACHIMI_BATCH }}
        run: |
          xvfb-run -a python hachimi_checkin.py

      # 8ï¸âƒ£ æäº¤æ—¶é—´æ–‡ä»¶
      - name: â±ï¸ æ›´æ–°æ—¶é—´æ–‡ä»¶
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com]"
          mkdir -p hachimi
          echo "$(date +'%Y-%m-%d %H:%M:%S')" > hachimi/time.txt
          git add hachimi/time.txt 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "æ— å˜åŒ–"
          else
            git fetch origin main
            git rebase origin/main
            git commit -m "â±ï¸ æ›´æ–° hachimi ç­¾åˆ°æ—¶é—´"
            git push origin HEAD:main
          fi
